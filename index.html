<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="theme-color" content="#4c51bf"/> 
    
    <title id="main-title">Mi Tienda Online | Gestor TPV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Estilos personalizados */
        html { font-family: 'Inter', sans-serif; } 
        .tab-button { transition: all 0.2s ease-in-out; } 
        /* Estilo para el modal */ 
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); } 
        .modal-content { animation: fadeInScale 0.2s ease-out; } 
        @keyframes fadeInScale { 
            from { opacity: 0; transform: scale(0.95); } 
            to { opacity: 1; transform: scale(1); } 
        } 
        /* Ajuste espec√≠fico para el contenedor principal en m√≥viles */
        @media (max-width: 640px) {
            .max-w-7xl {
                padding: 0.5rem; /* Reduce padding en pantallas peque√±as */
            }
        }
        /* Ajuste para el grid del dashboard en m√≥viles */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr; /* Una columna en lugar de 4 o 2 en m√≥viles */
            }
        }
        /* Estilo para radios para Tailwind CSS v3/4 */
        .form-radio {
            appearance: none;
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            border: 1px solid #d1d5db; /* gray-300 */
            vertical-align: middle;
            margin-right: 0.5rem;
            cursor: pointer;
        }
        .form-radio:checked {
            background-color: #4c51bf; /* indigo-600 */
            border-color: #4c51bf;
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #4c51bf;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm modal-content">
            <div class="p-6">
                <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-4">T√≠tulo del Modal</h3>
                <div id="modal-body" class="text-gray-700">Mensaje de prueba</div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button onclick="window.closeModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="flex flex-col sm:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-lg mb-6">
            <div class="flex items-center w-full sm:w-auto mb-4 sm:mb-0">
                <img src="logo.jpg" alt="Logo de la Tienda" class="h-10 w-10 mr-4 object-contain">
                <div>
                    <h1 class="text-3xl font-extrabold text-indigo-800" id="store-name-title">Mi Tienda Online</h1>
                    <p class="text-sm text-gray-500">Gestor de Ventas (TPV) / eCommerce</p>
                </div>
            </div>
            <div class="mt-4 sm:mt-0" id="mode-indicator">
                Modo: ONLINE (Firebase)
            </div>
        </header>

        <div id="notification-message" class="hidden fixed top-4 right-4 z-40 p-3 rounded-lg text-white font-semibold shadow-xl">
            Cargando...
        </div>

        <nav class="bg-white p-3 rounded-xl shadow-lg mb-6">
            <div class="flex flex-wrap gap-2 justify-center">
                <button data-tab="dashboard" onclick="window.setActiveView('dashboard')"
                    class="tab-button bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center text-sm">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    Dashboard
                </button>
                <button data-tab="products" onclick="window.setActiveView('products')"
                    class="tab-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-100 transition duration-200 flex items-center text-sm">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10m0-10l-4-2m4 2l4-2m-4 2l4 2"></path></svg>
                    Inventario
                </button>
                <button data-tab="sales" onclick="window.setActiveView('sales')"
                    class="tab-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-100 transition duration-200 flex items-center text-sm">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v1a2 2 0 01-2 2H5a2 2 0 01-2-2v-3h2m14 0h2v-3a2 2 0 00-2-2h-3m-5 3v1a2 2 0 01-2 2H5a2 2 0 01-2-2v-3a2 2 0 012-2h3m5 0h2a2 2 0 002-2v-3a2 2 0 00-2-2h-2m-7 0h2a2 2 0 012 2v3a2 2 0 01-2 2h-2m7 0a2 2 0 002 2v1a2 2 0 01-2 2h-2a2 2 0 01-2-2v-1a2 2 0 002-2z"></path></svg>
                    Venta
                </button>
                <button data-tab="clients" onclick="window.setActiveView('clients')"
                    class="tab-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-100 transition duration-200 flex items-center text-sm">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354l.365.366m0 0l5 5m-5-5v8m-5-5l5 5m0 0l5-5M7 10h10v2a2 2 0 01-2 2H9a2 2 0 01-2-2v-2"></path></svg>
                    Historial
                </button>
                <button data-tab="drive" onclick="window.setActiveView('drive')"
                    class="tab-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-100 transition duration-200 flex items-center text-sm">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2H7a2 2 0 00-2 2v2m14 0h-2M5 11h2"></path></svg>
                    Respaldo
                </button>
                <button data-tab="settings" onclick="window.setActiveView('settings')"
                    class="tab-button bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-100 transition duration-200 flex items-center text-sm">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35-.426.426-.693 1.13-.693 1.84 0 .71.267 1.414.693 1.84 1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-2.572 1.065c-.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572-1.065c-.426-1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35.426-.426.693-1.13.693-1.84 0-.71-.267-1.414-.693-1.84-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 002.573-1.066c.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572 1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Config
                </button>
            </div>
        </nav>

        <main id="content-area" class="bg-white p-6 rounded-xl shadow-lg min-h-[500px]">
            <p class="text-center py-10 text-gray-500">Cargando...</p>
        </main>

        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p id="creator-name-footer">Desarrollado por: Carlos E Hidalgo M.</p>
            <p>Contacto: <a id="creator-contact-footer" href="mailto:ingcehidalgo@gmail.com" class="text-indigo-600 hover:underline">ingcehidalgo@gmail.com</a></p>
            <p class="mt-2 text-xs">Sistema TPV H√≠brido.</p>
        </footer>
    </div>

    <script>
        // --- VARIABLES GLOBALES DE ESTADO ---
        let storeName = 'Mi Tienda Online';
        let currencySymbol = localStorage.getItem('currencySymbol') || 'USD'; 
        let products = [];
        let sales = [];
        let activeTab = 'dashboard';
        let messageTimeout = null;
        let nextLocalProductId = 1;
        let nextLocalSaleId = 1;
        const isOfflineMode = true;
        const isAuthReady = true;    

        // Datos del Creador
        const CREATOR_NAME = "Carlos E Hidalgo M.";
        const CREATOR_CONTACT = "ingcehidalgo@gmail.com";
        
        // --- UTILIDADES DE UI (Ventanas/Mensajes/Modal) ---
        const showMessage = (msg, isError = false) => {
            const msgEl = document.getElementById('notification-message');
            msgEl.textContent = msg;
            msgEl.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'animate-pulse');
            msgEl.classList.add(isError ? 'bg-red-500' : 'bg-green-500', 'animate-pulse');
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                msgEl.classList.add('hidden');
                msgEl.classList.remove('animate-pulse', 'bg-red-500', 'bg-green-500');
                msgEl.textContent = '';
            }, 5000);
        };

        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
        };

        window.confirmDeletion = () => {
            return window.confirm("¬øEst√°s seguro de que quieres eliminar este elemento? Esta acci√≥n no se puede deshacer.");
        };

        // **********************************************
        // ******* L√ìGICA DE INICIO Y DATOS LOCALES *******
        // **********************************************

        const setupLocalListeners = () => {
            // Cargar Moneda
            currencySymbol = localStorage.getItem('currencySymbol') || 'USD';

            // Cargar Nombre de Tienda
            storeName = localStorage.getItem('localStoreName') || 'Mi Tienda Online';
            localStorage.setItem('localStoreName', storeName);

            // Cargar Productos
            products = JSON.parse(localStorage.getItem('localProducts') || '[]');
            
            // Inicializar ejemplo si no hay datos
            if (products.length === 0) {
                products = [
                    // Valores iniciales en USD
                    { id: 'L-1', name: 'Laptop X10', price: 1200.00, cost: 900.00, stock: 5, sku: 'LPT10' },
                    { id: 'L-2', name: 'Mousepad Gamer', price: 25.50, cost: 15.00, stock: 15, sku: 'MPG25' },
                ];
            }
            localStorage.setItem('localProducts', JSON.stringify(products));

            // Calcular el siguiente ID local para productos
            nextLocalProductId = 1;
            if (products.length > 0) {
                const lastId = products.filter(p => p.id.startsWith('L-'))
                                         .map(p => parseInt(p.id.substring(2)))
                                         .reduce((max, current) => Math.max(max, current), 0);
                nextLocalProductId = lastId + 1;
            }
            
            // Cargar Ventas
            sales = JSON.parse(localStorage.getItem('localSales') || '[]');

            // Calcular el siguiente ID local para ventas
            nextLocalSaleId = 1;
            if (sales.length > 0) {
                const lastId = sales.filter(s => s.id.startsWith('S-'))
                                         .map(s => parseInt(s.id.substring(2)))
                                         .reduce((max, current) => Math.max(max, current), 0);
                nextLocalSaleId = lastId + 1;
            }
        };

        window.initApp = () => {
            setupLocalListeners();
            renderHeader();
            setActiveView('dashboard');
            showMessage("Modo Local (Offline) activado. Los datos se guardan en el navegador.");
        };

        // **********************************************
        // ******* FUNCIONES DE UTILIDAD *******
        // **********************************************

        const updateLocalStorage = (dataType = 'all') => {
            if (dataType === 'products' || dataType === 'all') {
                localStorage.setItem('localProducts', JSON.stringify(products));
            }
            if (dataType === 'sales' || dataType === 'all') {
                localStorage.setItem('localSales', JSON.stringify(sales));
            }
        };
        
        // FIX CR√çTICO: Usar c√≥digos ISO est√°ndar para el formato de moneda.
        const formatCurrency = (amount) => {
            const code = currencySymbol; // 'USD', 'EUR', 'VES'
            
            if (code === 'EUR') {
                // Formato para Euro
                return new Intl.NumberFormat('es-ES', { 
                    style: 'currency', 
                    currency: 'EUR', 
                    minimumFractionDigits: 2 
                }).format(amount);
            } 
            
            if (code === 'VES') {
                // Formato para Bol√≠var Soberano (Bs.) - Ajustado para Venezuela
                 return `Bs. ${new Intl.NumberFormat('es-VE', { 
                    minimumFractionDigits: 2 
                }).format(amount)}`; 
            }

            // Por defecto USD o cualquier otro c√≥digo
            return new Intl.NumberFormat('en-US', { 
                style: 'currency', 
                currency: code, 
                minimumFractionDigits: 2 
            }).format(amount);
        };

        // **********************************************
        // ******* FUNCIONES CRUD (PRODUCTOS) *******
        // **********************************************

        const saveProductLocal = (productData) => {
            const newProduct = {
                id: `L-${nextLocalProductId++}`,
                name: productData.name,
                price: parseFloat(productData.price),
                cost: parseFloat(productData.cost), // A√±adido costo para calcular ganancia
                stock: parseInt(productData.stock),
                sku: productData.sku || '',
                createdAt: new Date().toISOString()
            };
            products.push(newProduct);
            updateLocalStorage('products');
            showMessage(`Producto "${newProduct.name}" guardado exitosamente de forma local.`);
            if (activeTab === 'products') {
                updateProductsList();
            }
        };

        window.deleteProduct = (id) => {
            if (!window.confirmDeletion()) return;
            const initialLength = products.length;
            products = products.filter(p => p.id !== id);
            if (products.length < initialLength) {
                updateLocalStorage('products');
                showMessage("Producto eliminado con √©xito de forma local.");
                updateProductsList();
            } else {
                showMessage("Error: No se encontr√≥ el producto para eliminar.", true);
            }
        };

        window.handleAddProduct = () => {
            const name = document.getElementById('product-name').value;
            const price = document.getElementById('product-price').value;
            const cost = document.getElementById('product-cost').value; // Captura de costo
            const stock = document.getElementById('product-stock').value;
            const sku = document.getElementById('product-sku').value;
            
            if (name && price && cost && stock && parseFloat(price) >= 0 && parseFloat(cost) >= 0 && parseInt(stock) >= 0) {
                saveProductLocal({ name, price, cost, stock, sku });
                document.getElementById('product-form').reset();
            } else {
                showMessage("Por favor, rellena todos los campos requeridos con valores v√°lidos (Precio/Costo/Stock >= 0).", true);
            }
        };

        // **********************************************
        // ******* FUNCIONES CRUD (VENTAS) *******
        // **********************************************

        window.handleSellProduct = () => {
            const productId = document.getElementById('sale-product-id').value;
            const quantity = parseInt(document.getElementById('sale-quantity').value);
            const salePrice = parseFloat(document.getElementById('sale-price').value);

            const productIndex = products.findIndex(p => p.id === productId);

            if (productIndex === -1) {
                showMessage("Producto no encontrado.", true);
                return;
            }
            if (quantity <= 0 || isNaN(quantity)) {
                showMessage("La cantidad vendida debe ser mayor a cero.", true);
                return;
            }
            if (quantity > products[productIndex].stock) {
                showMessage(`Stock insuficiente. Disponible: ${products[productIndex].stock}`, true);
                return;
            }
            if (salePrice <= 0 || isNaN(salePrice)) {
                showMessage("El precio de venta debe ser mayor a cero.", true);
                return;
            }
            
            const product = products[productIndex];
            const totalSale = quantity * salePrice;
            const profit = quantity * (salePrice - product.cost);

            // 1. Registrar la venta
            const newSale = {
                id: `S-${nextLocalSaleId++}`,
                productId: productId,
                productName: product.name,
                quantity: quantity,
                salePriceUnit: salePrice,
                costPriceUnit: product.cost, // Guardamos el costo en el momento de la venta
                totalSale: totalSale,
                profit: profit,
                date: new Date().toISOString()
            };
            sales.push(newSale);
            updateLocalStorage('sales');

            // 2. Actualizar el stock
            products[productIndex].stock -= quantity;
            updateLocalStorage('products');

            showMessage(`Venta registrada: ${quantity} x ${product.name} por ${formatCurrency(totalSale)}.`, false);
            document.getElementById('sale-form').reset();
            // Si est√° en historial, actualiza la vista
            if (activeTab === 'clients') {
                 setActiveView('clients'); 
            }
        };


        // **********************************************
        // ******* FUNCIONES DE GR√ÅFICOS (DASHBOARD) *******
        // **********************************************

        const analyzeSalesData = () => {
            const monthlySales = {}; // { 'YYYY-MM': { sales: 0, profit: 0 } }
            const productPerformance = {}; // { productName: { totalSold: 0, totalRevenue: 0, totalProfit: 0 } }
            let totalProfit = 0;

            sales.forEach(sale => {
                const monthKey = sale.date.substring(0, 7); // YYYY-MM
                
                // 1. An√°lisis Mensual
                if (!monthlySales[monthKey]) {
                    monthlySales[monthKey] = { sales: 0, profit: 0 };
                }
                monthlySales[monthKey].sales += sale.totalSale;
                monthlySales[monthKey].profit += sale.profit;

                // 2. An√°lisis por Producto
                if (!productPerformance[sale.productName]) {
                    productPerformance[sale.productName] = { totalSold: 0, totalRevenue: 0, totalProfit: 0 };
                }
                productPerformance[sale.productName].totalSold += sale.quantity;
                productPerformance[sale.productName].totalRevenue += sale.totalSale;
                productPerformance[sale.productName].totalProfit += sale.profit;
                
                // 3. Ganancia Total Acumulada
                totalProfit += sale.profit;
            });
            
            return { monthlySales, productPerformance, totalProfit };
        };

        const renderCharts = (data) => {
            const { monthlySales, productPerformance, totalProfit } = data;

            // --- 1. Ventas y Ganancias Mensuales ---
            const monthKeys = Object.keys(monthlySales).sort();
            const monthlyRevenue = monthKeys.map(key => monthlySales[key].sales);
            const monthlyProfits = monthKeys.map(key => monthlySales[key].profit);

            const ctxMonthly = document.getElementById('monthlyChart').getContext('2d');
            // Destruye el gr√°fico anterior si existe para evitar errores de Chart.js
            if (window.monthlyChartInstance) window.monthlyChartInstance.destroy();
            window.monthlyChartInstance = new Chart(ctxMonthly, {
                type: 'bar',
                data: {
                    labels: monthKeys,
                    datasets: [
                        {
                            label: `Ventas Mensuales (${currencySymbol})`,
                            data: monthlyRevenue,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: `Ganancias Mensuales (${currencySymbol})`,
                            data: monthlyProfits,
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });


            // --- 2. Ventas por Producto (Top 5) ---
            const sortedProducts = Object.entries(productPerformance)
                .sort(([, a], [, b]) => b.totalRevenue - a.totalRevenue)
                .slice(0, 5); // Top 5
            
            const productLabels = sortedProducts.map(([name]) => name);
            const productRevenues = sortedProducts.map(([, data]) => data.totalRevenue);
            
            const ctxProduct = document.getElementById('productChart').getContext('2d');
            if (window.productChartInstance) window.productChartInstance.destroy();
            window.productChartInstance = new Chart(ctxProduct, {
                type: 'pie',
                data: {
                    labels: productLabels,
                    datasets: [{
                        label: `Ventas por Producto (${currencySymbol})`,
                        data: productRevenues,
                        backgroundColor: [
                            '#4c51bf', '#38b2ac', '#ecc94b', '#ed8936', '#f6ad55'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true }
            });

             // --- 3. Ganancia Total Acumulada ---
            const ctxTotalProfit = document.getElementById('totalProfitChart').getContext('2d');
            if (window.totalProfitChartInstance) window.totalProfitChartInstance.destroy();
            window.totalProfitChartInstance = new Chart(ctxTotalProfit, {
                type: 'doughnut',
                data: {
                    labels: ['Ganancia Neta', 'Costo de Venta'],
                    datasets: [{
                        label: `Ganancia Total (${currencySymbol})`,
                        data: [
                            totalProfit, 
                            sales.reduce((sum, s) => sum + (s.quantity * s.costPriceUnit), 0)
                        ],
                        backgroundColor: [
                            '#48bb78', // Ganancia
                            '#f56565'  // Costo
                        ],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true }
            });
        };

        // **********************************************
        // ******* FUNCIONES DE RESPALDO Y RESTAURACI√ìN LOCAL *******
        // **********************************************

        window.downloadBackup = () => {
            const backupData = {
                storeName: storeName,
                currencySymbol: currencySymbol, 
                products: products,
                sales: sales,
                exportedAt: new Date().toISOString(),
                // Metadatos para verificaci√≥n
                appVersion: 'TPV-v1.0-Local'
            };
            const fileContent = JSON.stringify(backupData, null, 2);
            const fileName = `Backup_Tienda_Local_${new Date().toISOString().substring(0, 10)}.json`;
            
            // Crear un objeto Blob con el contenido JSON
            const blob = new Blob([fileContent], { type: 'application/json' });
            
            // Crear un enlace de descarga y simular un clic
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage(`Respaldo descargado como "${fileName}". Gu√°rdalo en un lugar seguro.`);
        };

        window.handleRestoreFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    window.restoreBackup(data);
                } catch (error) {
                    showMessage("Error al leer el archivo. Aseg√∫rate de que es un archivo JSON v√°lido.", true);
                }
            };
            reader.readAsText(file);
        };

        window.restoreBackup = (data) => {
             // 1. Verificar la estructura m√≠nima del respaldo
            if (!data || !Array.isArray(data.products) || !Array.isArray(data.sales) || typeof data.storeName !== 'string') {
                showMessage("Estructura de respaldo inv√°lida. El archivo JSON debe contener 'products', 'sales' y 'storeName'.", true);
                return;
            }

            if (!window.confirm("ATENCI√ìN: Esto SOBRESCRIBIR√Å todos los datos de inventario y ventas guardados actualmente en tu navegador. ¬øEst√°s seguro de continuar?")) {
                return;
            }

            try {
                // 2. Sobrescribir los datos en localStorage
                localStorage.setItem('localStoreName', data.storeName);
                localStorage.setItem('currencySymbol', data.currencySymbol || 'USD'); // Usa USD si no est√° en el respaldo
                localStorage.setItem('localProducts', JSON.stringify(data.products));
                localStorage.setItem('localSales', JSON.stringify(data.sales));

                showMessage("Datos restaurados exitosamente. Recargando la aplicaci√≥n...");
                
                // 3. Recargar la aplicaci√≥n para aplicar los cambios
                setTimeout(() => {
                    window.location.reload();
                }, 1000); 

            } catch (e) {
                showMessage("Error al intentar guardar los datos restaurados en el navegador.", true);
                console.error("Restore error:", e);
            }
        };


        // **********************************************
        // ******* FUNCIONES DE RENDERIZADO (UI) *******
        // **********************************************

        const renderHeader = () => {
            document.getElementById('store-name-title').textContent = storeName;
            document.getElementById('main-title').textContent = `${storeName} | Gestor TPV`;
            document.getElementById('creator-name-footer').textContent = `Desarrollado por: ${CREATOR_NAME}`;
            document.getElementById('creator-contact-footer').href = `mailto:${CREATOR_CONTACT}`;
            document.getElementById('creator-contact-footer').textContent = CREATOR_CONTACT;
            document.getElementById('mode-indicator').textContent = 'Modo: LOCAL (Offline)';
            document.getElementById('mode-indicator').className = 'text-xs text-gray-500 font-semibold bg-yellow-100 px-2 py-1 rounded';
        };

        const renderDashboard = () => {
            const data = analyzeSalesData();
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, p) => sum + p.stock, 0);
            const totalSalesCount = sales.length;
            const totalRevenue = sales.reduce((sum, s) => sum + s.totalSale, 0);

            document.getElementById('content-area').innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Panel Principal y Estad√≠sticas</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 dashboard-grid">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <p class="text-sm font-medium text-gray-500">Total de Productos</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${totalProducts}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Stock Total (Unidades)</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${totalStock}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                        <p class="text-sm font-medium text-gray-500">Ventas Registradas (Transacciones)</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${totalSalesCount}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Ingreso Total</p>
                        <p class="text-3xl font-bold text-gray-900 mt-1">${formatCurrency(totalRevenue)}</p>
                    </div>
                </div>
                
                <h3 class="text-xl font-bold text-gray-700 mb-4">An√°lisis de Datos</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md border">
                        <h4 class="font-semibold mb-3">Ventas y Ganancias Mensuales</h4>
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border">
                        <h4 class="font-semibold mb-3">Ventas por Producto (Top 5 Ingresos)</h4>
                        <canvas id="productChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border lg:col-span-2 max-w-lg mx-auto">
                        <h4 class="font-semibold mb-3">Ganancia Total Acumulada (Neta vs. Costo)</h4>
                        <canvas id="totalProfitChart"></canvas>
                    </div>
                </div>
            `;
            
            // Renderizar los gr√°ficos despu√©s de que el canvas est√© en el DOM
            if (totalSalesCount > 0) {
                renderCharts(data);
            } else {
                document.getElementById('content-area').innerHTML += '<p class="text-center py-10 text-gray-500">A√∫n no hay suficientes ventas registradas para generar gr√°ficos.</p>';
            }
        };
        
        
        const updateProductsList = () => {
            const listEl = document.getElementById('products-list-table');
            if (!listEl) return;
            
            if (products.length === 0) {
                listEl.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No hay productos registrados.</td></tr>`;
                return;
            }
            
            listEl.innerHTML = products.map(p => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${p.name}</td>
                    <td class="px-6 py-4">${p.sku}</td>
                    <td class="px-6 py-4">${formatCurrency(p.price)}</td>
                    <td class="px-6 py-4">${p.stock}</td>
                    <td class="px-6 py-4">
                        <button onclick="window.deleteProduct('${p.id}')" class="text-red-600 hover:text-red-900 text-sm">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        };
        
        window.setActiveView = (viewName) => {
            activeTab = viewName;
            
            // 1. Actualizar botones
            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.dataset.tab === viewName) {
                    btn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-indigo-100');
                    btn.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                    btn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-indigo-100');
                }
            });

            // 2. Renderizar contenido
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = ''; 

            switch (viewName) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'products':
                    contentArea.innerHTML = `
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üì¶ Gesti√≥n de Inventario</h2>
                        <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                            <h3 class="text-xl font-semibold mb-4">A√±adir Nuevo Producto</h3>
                            <form id="product-form" onsubmit="event.preventDefault(); window.handleAddProduct();" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <input id="product-name" type="text" placeholder="Nombre del Producto" required class="p-2 border rounded">
                                <input id="product-price" type="number" step="0.01" placeholder="Precio Venta (${currencySymbol})" required class="p-2 border rounded">
                                <input id="product-cost" type="number" step="0.01" placeholder="Costo (${currencySymbol})" required class="p-2 border rounded">
                                <input id="product-stock" type="number" placeholder="Stock Inicial" required class="p-2 border rounded">
                                <input id="product-sku" type="text" placeholder="SKU/C√≥digo (Opcional)" class="p-2 border rounded">
                                <button type="submit" class="bg-indigo-600 text-white p-2 rounded hover:bg-indigo-700 col-span-1 sm:col-span-3">A√±adir Producto</button>
                            </form>
                        </div>
                        
                        <h3 class="text-xl font-semibold mb-4">Inventario Actual (${products.length} Productos)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="products-list-table" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    `;
                    updateProductsList();
                    break;
                case 'sales':
                     contentArea.innerHTML = `
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üõí Terminal de Punto de Venta (TPV)</h2>
                        <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                            <h3 class="text-xl font-semibold mb-4">Registrar Venta R√°pida</h3>
                            <form id="sale-form" onsubmit="event.preventDefault(); window.handleSellProduct();" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <select id="sale-product-id" required class="p-2 border rounded col-span-full lg:col-span-1">
                                    <option value="">-- Selecciona Producto --</option>
                                    ${products.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.stock})</option>`).join('')}
                                </select>
                                <input id="sale-quantity" type="number" placeholder="Cantidad" required class="p-2 border rounded" min="1">
                                <input id="sale-price" type="number" step="0.01" placeholder="Precio de Venta Final" required class="p-2 border rounded">
                                <button type="submit" class="bg-green-600 text-white p-2 rounded hover:bg-green-700">Registrar Venta</button>
                            </form>
                        </div>
                        <p class="text-center py-4 text-gray-500">Para ver las ventas registradas, navega a Historial.</p>
                    `;
                    break;
                case 'clients':
                    // Historial de ventas
                    contentArea.innerHTML = `
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìú Historial de Transacciones</h2>
                        <h3 class="text-xl font-semibold mb-4">√öltimas Ventas Registradas (${sales.length} Transacciones)</h3>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Venta</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cant.</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Venta</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ganancia</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-history-list" class="bg-white divide-y divide-gray-200">
                                    ${sales.length === 0 ? `<tr><td colspan="6" class="p-4 text-center text-gray-500">No hay ventas registradas.</td></tr>` : sales.slice().reverse().map(s => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${s.id}</td>
                                            <td class="px-6 py-4">${s.productName}</td>
                                            <td class="px-6 py-4">${s.quantity}</td>
                                            <td class="px-6 py-4 font-semibold">${formatCurrency(s.totalSale)}</td>
                                            <td class="px-6 py-4 text-green-600">${formatCurrency(s.profit)}</td>
                                            <td class="px-6 py-4">${new Date(s.date).toLocaleDateString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    break;
                case 'drive':
                    contentArea.innerHTML = `
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üíæ Respaldo y Restauraci√≥n Local</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-indigo-50 p-6 rounded-lg shadow-md border-t-4 border-indigo-600">
                                <h3 class="text-xl font-semibold mb-4 text-indigo-800">Exportar Respaldo (.json)</h3>
                                <p class="mb-4 text-gray-700">Descarga todos tus datos (inventario y ventas) en un archivo JSON local. **Gu√°rdalo en la nube o en otro dispositivo.**</p>
                                <button onclick="window.downloadBackup()" class="w-full bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition">
                                    Descargar Respaldo Ahora
                                </button>
                            </div>
                            <div class="bg-yellow-50 p-6 rounded-lg shadow-md border-t-4 border-yellow-600">
                                <h3 class="text-xl font-semibold mb-4 text-yellow-800">Importar Restauraci√≥n (.json)</h3>
                                <p class="mb-4 text-gray-700">Carga un archivo de respaldo JSON para **sobrescribir** los datos guardados en tu navegador.</p>
                                <label for="restore-file" class="block w-full text-center bg-yellow-600 text-white p-3 rounded-lg cursor-pointer hover:bg-yellow-700 transition">
                                    Seleccionar Archivo de Respaldo
                                </label>
                                <input type="file" id="restore-file" accept=".json" onchange="window.handleRestoreFile(event)" class="hidden">
                            </div>
                        </div>
                        <p class="mt-6 text-center text-sm text-gray-500">Nota: Al estar en modo LOCAL, el "Respaldo" se refiere a la copia de seguridad guardada en tu navegador.</p>
                    `;
                    break;
                case 'settings':
                    // **INICIO: Secci√≥n de Configuraci√≥n Reestructurada para coincidir con la imagen**
                    contentArea.innerHTML = `
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Configuraci√≥n de la Tienda</h2>
                        <div class="space-y-6">
                            
                            <div class="bg-white p-6 rounded-lg shadow-xl">
                                <h3 class="text-xl font-bold mb-4 text-gray-900">Nombre de la Tienda</h3>
                                <p class="text-sm text-gray-600 mb-4">Actual: <span class="font-semibold text-indigo-600">${storeName}</span></p>

                                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-6">
                                    <p class="font-bold text-indigo-800">**Ejemplo de Gu√≠a:** Introduce "Mi Caf√© Express" o "Electro Market".</p>
                                </div>

                                <form onsubmit="event.preventDefault(); window.saveStoreNameSetting();" class="space-y-4">
                                    <input id="setting-store-name" type="text" value="${storeName}" class="mt-1 block w-full p-2 border rounded-md shadow-sm">
                                    <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                                        Guardar
                                    </button>
                                </form>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-xl">
                                <h3 class="text-xl font-bold mb-4 text-gray-900">Moneda</h3>
                                <p class="text-sm text-gray-600 mb-4">S√≠mbolo actual: <span class="font-semibold text-indigo-600">${currencySymbol}</span></p>

                                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-6">
                                    <p class="font-bold text-indigo-800">**Ejemplo de Gu√≠a:** Selecciona la moneda principal que deseas utilizar.</p>
                                </div>

                                <form id="currency-form" onsubmit="event.preventDefault(); window.saveCurrencySetting();" class="space-y-4">
                                    <div class="flex items-center">
                                        <input type="radio" id="usd-radio" name="currency-radio" value="USD" class="form-radio text-indigo-600" ${currencySymbol === 'USD' ? 'checked' : ''}>
                                        <label for="usd-radio" class="ml-3 text-base font-medium text-gray-700">D√≥lar Americano (USD)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" id="eur-radio" name="currency-radio" value="EUR" class="form-radio text-indigo-600" ${currencySymbol === 'EUR' ? 'checked' : ''}>
                                        <label for="eur-radio" class="ml-3 text-base font-medium text-gray-700">Euro (‚Ç¨)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" id="ves-radio" name="currency-radio" value="VES" class="form-radio text-indigo-600" ${currencySymbol === 'VES' ? 'checked' : ''}>
                                        <label for="ves-radio" class="ml-3 text-base font-medium text-gray-700">Bol√≠var Venezolano (VES)</label>
                                    </div>

                                    <button type="submit" class="mt-4 w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                                        Guardar Moneda Seleccionada
                                    </button>
                                </form>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                                <h3 class="text-xl font-semibold mb-4">Opciones de Aplicaci√≥n H√≠brida (PWA)</h3>
                                <p class="text-gray-700">Esta aplicaci√≥n est√° dise√±ada para funcionar sin conexi√≥n.</p>
                                <p class="mt-2 text-sm text-gray-500">Usa el bot√≥n de abajo para instalarla en tu dispositivo como una aplicaci√≥n independiente.</p>
                                <button onclick="window.showInstallPrompt()" id="install-button" class="mt-4 bg-teal-500 text-white p-2 rounded hover:bg-teal-600 transition hidden">
                                    Instalar App (PWA)
                                </button>
                            </div>

                            <div class="bg-red-50 p-6 rounded-lg shadow-inner border-t-4 border-red-600">
                                <h3 class="text-xl font-semibold mb-4 text-red-800">Zona de Peligro</h3>
                                <p class="mb-4 text-gray-700">Esta acci√≥n **eliminar√° permanentemente** todos los datos guardados localmente (productos, ventas, configuraci√≥n) del navegador.</p>
                                <button onclick="window.clearAllData()" class="bg-red-600 text-white p-2 rounded hover:bg-red-700 transition">Borrar Todos los Datos Locales</button>
                            </div>

                        </div>
                    `;
                    // **FIN: Secci√≥n de Configuraci√≥n Reestructurada para coincidir con la imagen**
                    break;
                default:
                    contentArea.innerHTML = '<p class="text-center py-10 text-gray-500">Vista no encontrada.</p>';
            }
        };

        // **NUEVA FUNCI√ìN: Guarda solo el nombre de la tienda**
        window.saveStoreNameSetting = () => {
            const newStoreName = document.getElementById('setting-store-name').value;
            localStorage.setItem('localStoreName', newStoreName);
            
            storeName = newStoreName;
            renderHeader();
            showMessage("Nombre de la tienda guardado. Recargando vista...");
            setActiveView('settings'); 
        };
        
        // **NUEVA FUNCI√ìN: Guarda solo la moneda**
        window.saveCurrencySetting = () => {
            const selectedRadio = document.querySelector('input[name="currency-radio"]:checked');
            if (selectedRadio) {
                const newCurrencySymbol = selectedRadio.value;
                localStorage.setItem('currencySymbol', newCurrencySymbol);
                
                currencySymbol = newCurrencySymbol;
                renderHeader(); // Para actualizar el s√≠mbolo en el dashboard/otros
                showMessage("Moneda guardada. Recargando vista...");
                setActiveView('settings'); 
            } else {
                showMessage("Por favor, selecciona una moneda.", true);
            }
        };

        // **FUNCI√ìN ANTERIOR REMOVIDA O REEMPLAZADA: window.saveSettings() ha sido eliminado/reemplazado**
        
        window.clearAllData = () => {
            if (window.confirm("CONFIRMACI√ìN FINAL: ¬øEst√°s ABSOLUTAMENTE seguro de borrar TODOS los datos (Inventario y Ventas)? Esta acci√≥n es irreversible.")) {
                localStorage.removeItem('localProducts');
                localStorage.removeItem('localSales');
                localStorage.removeItem('localStoreName');
                localStorage.removeItem('currencySymbol');
                showMessage("Todos los datos locales han sido borrados. Recargando la aplicaci√≥n...", true);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        };
        
        // **********************************************
        // ******* L√ìGICA DEL SERVICE WORKER (PWA) *******
        // **********************************************

        let deferredPrompt; 

        window.addEventListener('beforeinstallprompt', (e) => {
            // Previene que el navegador muestre la ventana por defecto
            e.preventDefault(); 
            // Guarda el evento para que se pueda disparar m√°s tarde
            deferredPrompt = e; 
            // Muestra el bot√≥n de instalaci√≥n en la configuraci√≥n
            const installButton = document.getElementById('install-button');
            if (installButton) {
                installButton.classList.remove('hidden');
            }
            console.log("PWA Install Prompt guardado.");
        });

        window.showInstallPrompt = () => {
            if (deferredPrompt) {
                // Muestra la ventana de instalaci√≥n
                deferredPrompt.prompt();
                // Espera la respuesta del usuario
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showMessage('La aplicaci√≥n se est√° instalando...');
                    } else {
                        showMessage('Instalaci√≥n cancelada.', true);
                    }
                    // Limpia la variable despu√©s de usarla
                    deferredPrompt = null;
                    const installButton = document.getElementById('install-button');
                    if (installButton) {
                         installButton.classList.add('hidden');
                    }
                });
            } else {
                 showMessage('La aplicaci√≥n ya est√° instalada o la opci√≥n no est√° disponible.', true);
            }
        };

        window.addEventListener('load', () => {
            if ('serviceWorker' in navigator) {
                // Registra el Service Worker ubicado en la ra√≠z
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado con √©xito:', registration);
                        showMessage("PWA: El modo sin conexi√≥n est√° disponible.", false);
                        
                        // Si hay un Service Worker activo, verifica si hay actualizaciones pendientes
                        if (registration.waiting) {
                             showMessage("¬°Actualizaci√≥n de la App disponible! Recarga para aplicarla.", false);
                        }
                    })
                    .catch(error => {
                        console.error('Fallo en el registro del Service Worker:', error);
                        showMessage("PWA: Error al registrar el modo sin conexi√≥n.", true);
                    });
            } else {
                console.warn('El navegador no soporta Service Workers.');
            }
        });

        // Aseg√∫rate de que esta l√≠nea se llama para inicializar la app
        window.initApp();

    </script>
</body>
</html>